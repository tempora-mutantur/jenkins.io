<!DOCTYPE html>
<html lang="en">
<head>
<title>
Jenkins and Kubernetes - Secret Agents in the Clouds
</title>
<meta content="text/html; charset=UTF-8" http-equiv="Content-Type">
<meta content="Jenkins – an open source automation server which enables developers around the world to reliably build, test, and deploy their software" name="description">
<link href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/sites/default/files/jenkins_favicon.ico" rel="shortcut icon" type="image/x-icon">
<meta charset="utf-8">
<meta content="width=device-width, initial-scale=1" name="viewport">
<meta content="ie=edge" http-equiv="x-ua-compatible">
<link href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/img/favicon.ico" rel="icon" sizes="32x32" type="img/png">
<link href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/img/favicon-32x32.png" rel="icon" sizes="32x32" type="image/png">
<link href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/img/favicon-16x16.png" rel="icon" sizes="16x16" type="image/png">
<link href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/img/apple-touch-icon-76x76.png" rel="apple-touch-icon" sizes="76x76">
<link href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/img/apple-touch-icon-120x120.png" rel="apple-touch-icon" sizes="120x120">
<link href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/img/apple-touch-icon-152x152.png" rel="apple-touch-icon" sizes="152x152">
<meta content="Jenkins and Kubernetes - Secret Agents in the Clouds" name="apple-mobile-web-app-title">
<!-- Twitter Card data -->
<meta content="summary_large_image" name="twitter:card">
<meta content="@JenkinsCI" name="twitter:site">
<meta content="Jenkins and Kubernetes - Secret Agents in the Clouds" name="twitter:title">
<meta content="Jenkins – an open source automation server which enables developers around the world to reliably build, test, and deploy their software" name="twitter:description">
<meta content="@JenkinsCI" name="twitter:creator">
<!-- Twitter Summary card images must be at least 120x120px -->
<meta content="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/images/logo-title-opengraph.png" name="twitter:image">
<!-- Open Graph data -->
<meta content="Jenkins and Kubernetes - Secret Agents in the Clouds" property="og:title">
<meta content="article" property="og:type">
<meta content="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/blog/2018/09/14/kubernetes-and-secret-agents/index.html" property="og:url">
<meta content="Jenkins – an open source automation server which enables developers around the world to reliably build, test, and deploy their software" name="og:description">
<meta content="Jenkins and Kubernetes - Secret Agents in the Clouds" property="og:site_name">
<meta content="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/images/logo-title-opengraph.png" name="og:image">
<link href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/assets/bower/bootstrap/css/bootstrap.min.css" media="screen" rel="stylesheet">
<link href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/assets/bower/tether/css/tether.min.css" media="screen" rel="stylesheet">
<link href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/css/font-icons.css" media="screen" rel="stylesheet">
<link href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/css/jenkins.css" media="screen" rel="stylesheet">
<!-- Non-obtrusive CSS styles -->
<link href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/assets/bower/ionicons/css/ionicons.min.css" media="screen" rel="stylesheet">
<link href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/css/footer.css" media="screen" rel="stylesheet">
<link href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/css/font-awesome.min.css" media="screen" rel="stylesheet">
</head>
<body>
<script src="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/assets/bower/jquery/jquery.min.js"></script>
<!-- starting partial toptoolbar.html.haml -->
<nav class="navbar navbar-expand-md navbar-dark top bg-dark fixed-top" id="ji-toolbar">
<a class="navbar-brand" href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test">
Jenkins
</a>
<button class="navbar-toggler" data-target="#CollapsingNavbar" data-toggle="collapse" type="button">
<span class="navbar-toggler-icon"></span>
</button>
<div class="collapse navbar-collapse" id="CollapsingNavbar">
<ul class="nav navbar-nav ml-auto">
<li class="nav-item">
<a class="nav-link" href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/node">
Blog
</a>
</li>
<li class="nav-item dropdown">
<!-- starting partial dropdown.html.haml -->
<button aria-expanded="false" aria-haspopup="true" class="nav-link dropdown-toggle" data-toggle="dropdown">
Documentation
</button>

<!-- ending partial dropdown.html.haml -->
<div class="dropdown-menu">
<a class="dropdown-item" href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/doc">
Use Jenkins
</a>
<a class="dropdown-item" href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/doc/developer">
Extend Jenkins
</a>
<span class="dropdown-item">
<strong>
Use-cases
</strong>
</span>
<a class="dropdown-item feature" href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/solutions/android">
&nbsp;-&nbsp;Android
</a>
<a class="dropdown-item feature" href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/solutions/c">
&nbsp;-&nbsp;C/C++
</a>
<a class="dropdown-item feature" href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/solutions/docker">
&nbsp;-&nbsp;Docker
</a>
<a class="dropdown-item feature" href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/solutions/embedded">
&nbsp;-&nbsp;Embedded
</a>
<a class="dropdown-item feature" href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/solutions/github">
&nbsp;-&nbsp;GitHub
</a>
<a class="dropdown-item feature" href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/solutions/java">
&nbsp;-&nbsp;Java
</a>
<a class="dropdown-item feature" href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/solutions/php">
&nbsp;-&nbsp;PHP
</a>
<a class="dropdown-item feature" href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/solutions/pipeline">
&nbsp;-&nbsp;Continuous Delivery
</a>
<a class="dropdown-item feature" href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/solutions/python">
&nbsp;-&nbsp;Python
</a>
<a class="dropdown-item feature" href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/solutions/ruby">
&nbsp;-&nbsp;Ruby
</a>
</div>
</li>
<li class="nav-item">
<a class="nav-link" href="https://plugins.jenkins.io/">
Plugins
</a>
</li>
<li class="nav-item dropdown">
<!-- starting partial dropdown.html.haml -->
<button aria-expanded="false" aria-haspopup="true" class="nav-link dropdown-toggle" data-toggle="dropdown">
Community
</button>

<!-- ending partial dropdown.html.haml -->
<div class="dropdown-menu">
<a class="dropdown-item feature" href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/participate">
Overview
</a>
<a class="dropdown-item feature" href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/chat" title="Chat with the rest of the Jenkins community on IRC">
Chat
</a>
<a class="dropdown-item feature" href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/projects/jam">
Meet
</a>
<a class="dropdown-item feature" href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/events">
Events
</a>
<a class="dropdown-item feature" href="https://issues.jenkins-ci.org/">
Issue Tracker
</a>
<a class="dropdown-item feature" href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/mailing-lists" title="Browse Jenkins mailing list archives and/or subscribe to lists">
Mailing Lists
</a>
<a class="dropdown-item feature" href="https://wiki.jenkins.io/">
Wiki
</a>
<a class="dropdown-item feature" href="https://accounts.jenkins.io/" title="Create/manage your account for accessing wiki, issue tracker, etc">
Account Management
</a>
<a class="dropdown-item feature" href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/sigs/">
<strong>
Special Interest Groups
</strong>
</a>
<a class="dropdown-item feature" href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/sigs/advocacy-and-outreach/">
&nbsp;-&nbsp;Advocacy and Outreach
</a>
<a class="dropdown-item feature" href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/sigs/chinese-localization/">
&nbsp;-&nbsp;Chinese Localization
</a>
<a class="dropdown-item feature" href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/sigs/cloud-native/">
&nbsp;-&nbsp;Cloud Native
</a>
<a class="dropdown-item feature" href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/sigs/docs/">
&nbsp;-&nbsp;Documentation
</a>
<a class="dropdown-item feature" href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/sigs/gsoc/">
&nbsp;-&nbsp;Google Summer of Code
</a>
<a class="dropdown-item feature" href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/sigs/hw-and-eda/">
&nbsp;-&nbsp;Hardware and EDA
</a>
<a class="dropdown-item feature" href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/sigs/pipeline-authoring/">
&nbsp;-&nbsp;Pipeline Authoring
</a>
<a class="dropdown-item feature" href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/sigs/platform/">
&nbsp;-&nbsp;Platform
</a>
</div>
</li>
<li class="dropdown nav-item">
<!-- starting partial dropdown.html.haml -->
<button aria-expanded="false" aria-haspopup="true" class="nav-link dropdown-toggle" data-toggle="dropdown">
Subprojects
</button>

<!-- ending partial dropdown.html.haml -->
<div class="dropdown-menu">
<a class="dropdown-item feature" href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/projects/">
Overview
</a>
<a class="dropdown-item feature" href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/projects/blueocean/">
Blue Ocean
</a>
<a class="dropdown-item feature" href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/projects/evergreen/">
Evergreen
</a>
<a class="dropdown-item feature" href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/projects/gsoc/">
Google Summer of Code in Jenkins
</a>
<a class="dropdown-item feature" href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/projects/infrastructure/">
Infrastructure
</a>
<a class="dropdown-item feature" href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/projects/jam/">
Jenkins Area Meetups
</a>
<a class="dropdown-item feature" href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/projects/jcasc/">
Jenkins Configuration as Code
</a>
<a class="dropdown-item feature" href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/projects/remoting/">
Jenkins Remoting
</a>
</div>
</li>
<li class="nav-item dropdown">
<!-- starting partial dropdown.html.haml -->
<button aria-expanded="false" aria-haspopup="true" class="nav-link dropdown-toggle" data-toggle="dropdown">
About
</button>

<!-- ending partial dropdown.html.haml -->
<div class="dropdown-menu">
<a class="dropdown-item" href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/security">
Security
</a>
<a class="dropdown-item" href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/press">
Press
</a>
<a class="dropdown-item" href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/awards">
Awards
</a>
<a class="dropdown-item" href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/project/conduct">
Conduct
</a>
<a class="dropdown-item" href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/artwork">
Artwork
</a>
</div>
</li>
<li class="nav-item dropdown">
<!-- starting partial dropdown.html.haml -->
<button aria-expanded="false" aria-haspopup="true" class="nav-link dropdown-toggle" data-toggle="dropdown">
English
</button>

<!-- ending partial dropdown.html.haml -->
<div class="dropdown-menu">
<a class="dropdown-item" href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/zh">
中文 Chinese
</a>
</div>
</li>
<li class="nav-item">
<a class="nav-link btn btn-outline-secondary" href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/download">
Download
</a>
</li>
</ul>
</div>
</nav>
<!-- Spacing to make the fixed-top sticky navbar not occlude any content below it -->
<div class="pt-4">
&nbsp;
</div>

<!-- ending partial toptoolbar.html.haml -->
<script>
  $(function () {
    for (var i = 1 ; i <= 6 ; i ++) {
      anchors.add('#content h' + i);
    }
  })
</script>
<div class="container blog-post">
<div class="row body">
<div class="col-md-11 col-md-offset-1 main-content" id="content">
<div id="content-top">
<h1>
<a href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/blog/2018/09/14/kubernetes-and-secret-agents/" title="Jenkins and Kubernetes - Secret Agents in the Clouds">
Jenkins and Kubernetes - Secret Agents in the Clouds
</a>
</h1>
<div style="float: right; clear: all;">
<a class="twitter-share-button" data-lang="en" href="https://twitter.com/share">
Tweet
</a>
</div>
<div class="post-attrs">
<span class="submitted">
Published on
2018-09-14
by
<a href="/blog/authors/devmandy">Mandy Hubbard</a>
</span>
<ul class="list-inline tags">
<li>
<a class="tag-link" href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/node/tags/jenkinsworld">
jenkinsworld
</a>
</li>
<li>
<a class="tag-link" href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/node/tags/jenkinsworld2018">
jenkinsworld2018
</a>
</li>
<li>
<a class="tag-link" href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/node/tags/cloud-native">
cloud-native
</a>
</li>
<li>
<a class="tag-link" href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/node/tags/kubernetes">
kubernetes
</a>
</li>
</ul>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This is a guest post by <em>DevOps World | Jenkins World</em> speaker
<a href="https://devopsworldjenkinsworld2018.sched.com/speaker/mandy_hubbard.1y8j4r23">Mandy Hubbard</a>.
</td>
</tr>
</table>
</div>
<div class="imageblock right">
<div class="content">
<a class="image" href="https://www.cloudbees.com/devops-world"><img src="/images/conferences/devops-world-2018.jpg" alt="DevOps World | Jenkins World 2018"></a>
</div>
</div>
<div class="paragraph">
<p>At long last, the way we build and deploy software is finally changing and significantly so.
The days of the persnickety, prima donna build machine where monolithic applications were built, tested, and deployed are numbered.
And that is a "Good Thing (tm)" - a consequence of how we will meet the transformation goals of our businesses.
Modern applications consist of distributed services, often with multiple microservices that are developed and deployed independent of other services.
However, the only way to build these services with their own dependencies and schedules is to bake in continuous integration and delivery from the beginning.
And as usual, your Jenkins platform is your friend.</p>
</div>
<div class="paragraph">
<p>But let’s take a moment and think about that in the context of microservices, especially if you’ve only used Jenkins for monolithic applications.
You’ll be creating a greater number of individual Jenkins jobs that each run multiple times a day.
This is a significant process change, and it’s important to acknowledge this and change our approach to managing Jenkins to accommodate these changes.
It’s well within Jenkins’ capabilities, but you will need to think a little differently, and invest to close those last-mile deployment gaps.</p>
</div>
<div class="sect1">
<h2 id="evolution-of-my-jenkins-environment"><a class="anchor" href="#evolution-of-my-jenkins-environment"></a>Evolution of my Jenkins Environment</h2>
<div class="sectionbody">
<div class="paragraph">
<p>One of the biggest challenges I’ve faced as a DevOps practitioner is a long and evolving set of options to manage my Jenkins agent infrastructure.
With only a few large jobs you don’t really need to worry too much about your agents.
But when you’re orchestrating the CI/CD pipelines for dozens or even hundreds of services, optimizing efficiency and minimizing cost becomes important.
And that journey has allowed me to consider and test many different Jenkins build agent architectures over the years.
This journey may be familiar to you as well.</p>
</div>
<div class="paragraph">
<p>These are the types of Jenkins environments I’ve run over the years.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Execute all the builds on the master.
Concentrate all the moving parts on one instance.
(I call this Hello Jenkins)</p>
</li>
<li>
<p>Create a Jenkins EC2 agent with all the required tools for building every service, and then clone it if I need to “scale” Jenkins.
(I call this the Monster Agent.)</p>
</li>
<li>
<p>Create an individual Jenkins EC2 agent for each service I need to build.
(I call this the Snowflake Agent.)</p>
</li>
<li>
<p>Run build steps in containers.
For example, launching agents in containers using the
<a href="https://wiki.jenkins.io/display/JENKINS/Docker+Plugin">Docker Plugin</a> or using multi-stage Dockerfiles to encapsulate all the logic for building, testing and packaging an application.
They are both good first steps in container abstraction and allow you to easily copy artifacts from one container to another.
Of course, access to a Docker engine is required for either approach, and I’ve managed my Docker host(s) for running Jenkins agents several different ways:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Run the Docker engine inside my Jenkins master container - Docker in Docker (DinD)</p>
</li>
<li>
<p>Mount the Docker socket of the host on which my Jenkins master container runs, allowing agents to run as sibling or sidecar containers - Docker outside of Docker (DooD)</p>
</li>
<li>
<p>Configure a single external EC2 Docker host for the Jenkins master to use for launching builds in containers</p>
</li>
<li>
<p>Dynamically launch agents using the EC2 plugin with an AMI that contains the Docker Engine and then run all the steps in a multi-stage Dockerfile</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>All these approaches were attempts to get out of the business of curating and managing Jenkins agents and infrastructure, each with their own benefits and drawbacks.
But recently I begin working in a new Jenkins environment - Jenkins on Kubernetes.</p>
</div>
<div class="paragraph">
<p>Once you’ve come to view Jenkins, build agents and jobs as containerized services, migrating platforms becomes much more straightforward.
And total disclaimer here - I had never used Kubernetes in my life, not even for side projects - when I set out to do this.
That said, it was surprisingly simple to create a Kubernetes cluster in Google Cloud Platform’s (GCP) GKE, launch a Jenkins master using a
<a href="https://helm.sh/">Helm</a> chart and begin running build steps in Jenkins agents running in containers on my new Kubernetes cluster.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="launch-agents-in-kubernetes-from-your-pipeline-scripts"><a class="anchor" href="#launch-agents-in-kubernetes-from-your-pipeline-scripts"></a>Launch agents in Kubernetes from your pipeline scripts</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The focus of this post and my Jenkins World talk for 2018, is to show you how to configure Jenkins to launch agents in Kubernetes from your pipeline scripts.
My examples assume you are launching your agents in the same Kubernetes cluster where your Jenkins master is running, but there are other options.
You’ll begin by installing the
<a href="https://plugins.jenkins.io/kubernetes">Kubernetes plugin</a>.
As a bonus, when I installed Jenkins using the latest stable chart in the default Helm repository, the Kubernetes plugin was automatically installed for me.</p>
</div>
<div class="paragraph">
<p>Once you get the Jenkins master running on your Kubernetes cluster, there are only a few configuration steps required and then you can begin launching ephemeral build agents on Kubernetes.</p>
</div>
<div class="sect2">
<h3 id="configure-the-jenkins-master"><a class="anchor" href="#configure-the-jenkins-master"></a>Configure the Jenkins Master</h3>
<div class="paragraph">
<p>You’ll first need to create a credentials set for the Jenkins master to access the Kubernetes cluster.
To do this, perform the following steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>In the Jenkins UI, click the <em>Credentials</em> link in the left-hand navigation pane</p>
</li>
<li>
<p>Click the arrow next to <em>(global)</em> in the <em>Stores scoped to Jenkins</em> table (you have to hover next to the link to see the arrow)</p>
</li>
<li>
<p>Click <em>Add Credentials</em></p>
</li>
<li>
<p>Under Kind, specify <em>Kubernetes Service Account</em></p>
</li>
<li>
<p>Leave the scope set to <em>Global</em></p>
</li>
<li>
<p>Click OK.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>That’s it! This configuration allows the Jenkins master to use a Kubernetes service account to access the Kubernetes API.</p>
</div>
</div>
<div class="sect2">
<h3 id="create-a-cloud-configuration-on-the-jenkins-master"><a class="anchor" href="#create-a-cloud-configuration-on-the-jenkins-master"></a>Create a Cloud Configuration on the Jenkins Master</h3>
<div class="paragraph">
<p>The next step is to create a cloud configuration for your K8s cluster.
(When I use K8s instead of Kubernetes it’s because it is quicker to type, not just for coolness.)</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>In the Jenkins UI, go to <em>Manage Jenkins</em> &#8594; <em>Configure System</em></p>
</li>
<li>
<p>Scroll down until you see <em>Cloud settings</em> and click the <em>Add a new cloud box</em> and select <em>kubernetes</em></p>
</li>
<li>
<p>The following parameters must be set:</p>
<div class="ulist">
<ul>
<li>
<p><strong>Name</strong>: &lt;your choice&gt; - This defaults to <code>kubernetes</code></p>
</li>
<li>
<p><strong>Kubernetes URL</strong>: <code>https://kubernetes.default</code> - This was automatically configured from the service account.</p>
</li>
<li>
<p><strong>Kubernetes Namespace</strong>: <code>default</code> - Unless you are running your master in another namespace</p>
</li>
<li>
<p><strong>Credentials</strong>:  Select the Kubernetes Service Account credentials you created in the previous step</p>
</li>
<li>
<p><strong>Jenkins URL</strong>: <code>http://&lt;your_jenkins_hostname&gt;:8080</code></p>
</li>
<li>
<p><strong>Jenkins tunnel</strong>: <code>&lt;your_jenkins_hostname&gt;:5555</code> - This is the port that is used to communicate with an agent</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/post-images/2018-09-14-secret-agents/image1.png" alt="Kubernetes Configuration" width="800">
</div>
</div>
<div class="paragraph">
<p>These were the only parameters I had to set to launch an agent in my K8s cluster.
You can certainly modify other parameters to tweak your environment.</p>
</div>
<div class="paragraph">
<p>Now that you’ve configured your Jenkins master so that it can access your K8s cluster, it’s time to define some pods.
A pod is the basic building block of Kubernetes and consists of one or more containers with shared network and storage.
Each Jenkins agent is launched as a Kubernetes pod.
It will always contain the default JNLP container that runs the Jenkins agent jar and any other containers you specify in the pod definition.
There are at least two ways to configure pod templates – in the Jenkins UI and in your pipeline script.</p>
</div>
</div>
<div class="sect2">
<h3 id="configure-a-pod-template-in-the-jenkins-ui"><a class="anchor" href="#configure-a-pod-template-in-the-jenkins-ui"></a>Configure a Pod Template in the Jenkins UI</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>In the Jenkins UI, go to <em>Manage Jenkins</em> &#8594; <em>Configure Systems</em></p>
</li>
<li>
<p>Scroll down to the cloud settings you configured in the previous step</p>
</li>
<li>
<p>Click the <em>Add Pod Template</em> button and select <em>Kubernetes Pod Template</em></p>
</li>
<li>
<p>Enter values for the following parameters:</p>
<div class="ulist">
<ul>
<li>
<p><strong>Name</strong>: <code>&lt;your choice&gt;</code></p>
</li>
<li>
<p><strong>Namespace</strong>: <code>default</code> - unless you configured a different namespace in the previous step</p>
</li>
<li>
<p><strong>Labels</strong>: <code>&lt;your choice&gt;</code> - this will be used to identify the agent pod from your Jenkinsfiles</p>
</li>
<li>
<p><strong>Usage</strong>: Select "<em>Use this node as much as possible</em>" if you would like for this pod to be your default node when no node is specified.
Select "<em>Only build jobs with label matching expressions matching this node</em>" to use this pod only when its label is specified in the pipeline script</p>
</li>
<li>
<p><strong>The name of the pod template to inherit from</strong> - you can leave this blank.
It will be useful once you gain experience with this configuration, but don’t worry about it for now.</p>
</li>
<li>
<p><strong>Containers</strong>: The containers you want to launch inside this pod.
This is described in detail below.</p>
</li>
<li>
<p><strong>EnvVars</strong>: The environment variables you would like to inject into your pod at runtime.
This is described in detail below.</p>
</li>
<li>
<p><strong>Volumes</strong>:  Any volumes you want to mount inside your pod.
This is described further below.</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/post-images/2018-09-14-secret-agents/image2.png" alt="Kubernetes Pod Template" width="800">
</div>
</div>
<div class="paragraph">
<p>Remember that a pod consists of one or more containers that live and die together.
The pod must always include a JNLP container, which is configured by default if you installed the master using the Helm Chart.
However, you will want to add containers with the tool chains required to build your application.</p>
</div>
</div>
<div class="sect2">
<h3 id="add-your-own-container-template"><a class="anchor" href="#add-your-own-container-template"></a>Add Your Own Container Template</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>In the Jenkins UI, return to the pod template you created in the last step</p>
</li>
<li>
<p>Click the <em>Add Container</em> button and select <em>Container Template</em></p>
</li>
<li>
<p>Enter values in the following fields:</p>
<div class="ulist">
<ul>
<li>
<p><strong>Name</strong>:  <code>&lt;your choice&gt;</code></p>
</li>
<li>
<p><strong>Docker image</strong>: any Docker image you’d like
For example, if you are building an application written in Go, you can enter <code>'golang:1.11-alpine3.8'</code></p>
</li>
<li>
<p><strong>Label</strong>: Enter any label strings you’d like to use to refer to this container template in your pipeline scripts</p>
</li>
<li>
<p><strong>Always pull image</strong>: - Select this option if you want the plugin to pull the image each time a pod is created.</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/post-images/2018-09-14-secret-agents/image3.png" alt="Container Template" width="800">
</div>
</div>
<div class="paragraph">
<p>You can leave the default values for the other parameters, but you can see that the plugin gives you fine-grained control over your pod and the individual containers that run within it.
Any values you might set in your Kubernetes pod configuration can be set via this plugin as well.
You can also inject your configuration data by entering raw YAML.
I encourage you not to get distracted by the sheer number of options you can configure in this plugin.
You only have to configure a small subset of them to get a working environment.</p>
</div>
<div class="paragraph">
<p>You can click the <em>Add Environment Variable</em> button in the container template to inject environment variables into a specific container.
You can click the <em>Add Environment Variable</em> button in the pod template to inject environment variables into all containers in the pod.
The following environment variables are automatically injected into the default JNLP container to allow it to connect automatically to the Jenkins master:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>JENKINS_URL</code>: Jenkins web interface url</p>
</li>
<li>
<p><code>JENKINS_JNLP_URL</code>: url for the jnlp definition of the specific slave</p>
</li>
<li>
<p><code>JENKINS_SECRET</code>: the secret key for authentication</p>
</li>
<li>
<p><code>JENKINS_NAME</code>: the name of the Jenkins agent</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If you click the <em>Add Volume</em> button in the pod template, you’ll see several options for adding volumes to your pod.
I use the <em>Host Path Volume</em> option to mount the docker socket inside the pod.
I can then run a container with the Docker client installed and use the host Docker socket to build and push Docker images.</p>
</div>
<div class="paragraph">
<p>At this point, we’ve created a cloud configuration for our Kubernetes cluster and defined a pod consisting of one or more containers.
Now, how do we use this to run Jenkins jobs? We simply refer to the pod and containers by label in our Jenkins pipeline script.
We use the label we gave to the pod in the node block and the label for the container we wish to use in the container block.
The examples in this post use scripted pipeline, but you can achieve the same outcome using the declarative pipeline syntax:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="groovy">node(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">test-pod</span><span style="color:#710">'</span></span>) {
    stage(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Checkout</span><span style="color:#710">'</span></span>) {
        checkout scm
    }
    stage(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Build</span><span style="color:#710">'</span></span>){
        container(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">go-agent</span><span style="color:#710">'</span></span>) {
            <span style="color:#777">// This is where we build our code.</span>
        }
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="defining-the-pod-in-the-jenkinsfile"><a class="anchor" href="#defining-the-pod-in-the-jenkinsfile"></a>Defining the Pod in the Jenkinsfile</h3>
<div class="paragraph">
<p>Configuring a plugin through the UI is perfectly fine in a proof of concept.
However, it does not result in a software-defined infrastructure that can be versioned and stored right alongside your source code.
Luckily, you can create the entire pod definition directly in your Jenkinsfile.
Is there anything you can’t do in a Jenkinsfile???</p>
</div>
<div class="paragraph">
<p>Any of the configuration parameters available in the UI or in the YAML definition can be added to the <code>podTemplate</code> and <code>containerTemplate</code> sections.
In the example below, I’ve defined a pod with two container templates.
The pod label is used in the node block to signify that we want to spin up an instance of this pod.
Any steps defined directly inside the node block but not in a container block with be run in the default JNLP container.</p>
</div>
<div class="paragraph">
<p>The <code>container</code> block is used to signify that the steps inside the block should be run inside the container with the given label.
I’ve defined a container template with the label <code>'golang'</code>, which I will use to build the Go executable that I will eventually package into a Docker image.
In the <code>volumes</code> definition, I have indicated that I want to mount the Docker socket of the host, but I still need the Docker client to interact with it using the Docker API.
Therefore, I’ve defined a container template with the label <code>'docker'</code> which uses an image with the Docker client installed.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="groovy">podTemplate(
    <span style="color:#606">name</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">test-pod</span><span style="color:#710">'</span></span>,
    <span style="color:#606">label</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">test-pod</span><span style="color:#710">'</span></span>,
    <span style="color:#606">containers</span>: [
        containerTemplate(<span style="color:#606">name</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">golang</span><span style="color:#710">'</span></span>, <span style="color:#606">image</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">golang:1.9.4-alpine3.7</span><span style="color:#710">'</span></span>),
        containerTemplate(<span style="color:#606">name</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">docker</span><span style="color:#710">'</span></span>, <span style="color:#606">image</span>:<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">trion/jenkins-docker-client</span><span style="color:#710">'</span></span>),
    ],
    <span style="color:#606">volumes</span>: [
        hostPathVolume(<span style="color:#606">mountPath</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/var/run/docker.sock</span><span style="color:#710">'</span></span>,
        <span style="color:#606">hostPath</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/var/run/docker.sock</span><span style="color:#710">'</span></span>,
    ],
    {
        <span style="color:#777">//node = the pod label</span>
        node(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">test-pod</span><span style="color:#710">'</span></span>){
            <span style="color:#777">//container = the container label</span>
            stage(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Build</span><span style="color:#710">'</span></span>){
                container(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">golang</span><span style="color:#710">'</span></span>){
                    <span style="color:#777">// This is where we build our code.</span>
                }
            }
            stage(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Build Docker Image</span><span style="color:#710">'</span></span>){
                container(<span style="color:#F00;background-color:#FAA">‘</span>docker<span style="color:#F00;background-color:#FAA">’</span>){
                    <span style="color:#777">// This is where we build the Docker image</span>
                }
            }
        }
    })</code></pre>
</div>
</div>
<div class="paragraph">
<p>In my Docker-based pipeline scripts, I was building Docker images and pushing them to a Docker registry, and it was important to me to replicate that exactly with my new Kubernetes setup.
Once I accomplished that, I was ready to build my image using <code>gcloud</code>, the Google Cloud SDK, and push that image to the Google Container Registry in anticipation of deploying to my K8s cluster.</p>
</div>
<div class="paragraph">
<p>To do this, I specified a container template using a gcloud image and changed my docker command to a gcloud command.
It’s that simple!</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="groovy">podTemplate(
    <span style="color:#606">name</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">test-pod</span><span style="color:#710">'</span></span>,
    <span style="color:#606">label</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">test-pod</span><span style="color:#710">'</span></span>,
    <span style="color:#606">containers</span>: [
        containerTemplate(<span style="color:#606">name</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">golang</span><span style="color:#710">'</span></span>, <span style="color:#606">image</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">golang:1.9.4-alpine3.7</span><span style="color:#710">'</span></span>),
        containerTemplate(<span style="color:#606">name</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">gcloud</span><span style="color:#710">'</span></span>, <span style="color:#606">image</span>:<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">gcr.io/cloud-builders/gcloud</span><span style="color:#710">'</span></span>),
    ],
    {
        <span style="color:#777">//node = the pod label</span>
        node(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">test-pod</span><span style="color:#710">'</span></span>){
            <span style="color:#777">//container = the container label</span>
            stage(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Build</span><span style="color:#710">'</span></span>){
                container(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">golang</span><span style="color:#710">'</span></span>){
                    <span style="color:#777">// This is where we build our code.</span>
                }
            }
            stage(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Build Docker Image</span><span style="color:#710">'</span></span>){
                container(<span style="color:#F00;background-color:#FAA">‘</span>gcloud<span style="color:#F00;background-color:#FAA">’</span>){
                    <span style="color:#777">//This is where we build and push our Docker image.</span>
                }
            }
        }
    })</code></pre>
</div>
</div>
<div class="paragraph">
<p>Standing up a Jenkins master on Kubernetes, running ephemeral agents, and building and deploying a sample application only took me a couple of hours.
I spent another weekend really digging in to better understand the platform.
You can be up and running in a matter of days if you are a quick study.
There are a wealth of resources available on running Jenkins on Kubernetes, and I hope this blog post helps to further that knowledge.
Even better, come to
<a href="https://devopsworldjenkinsworld2018.sched.com/event/F9Ne/jenkins-and-kubernetes-secret-agents-in-the-cloud">my session at Jenkins World</a> and let&#8217;s talk in person.</p>
</div>
<div class="paragraph">
<p>So, what else do you want to know?
Hit me up on Twitter.
I might even add your questions to my Jenkins World session.
I suppose next up is Mesos?</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Come meet Mandy and other Jenkins and Kubernetes experts at
<a href="https://www.cloudbees.com/devops-world">Jenkins World</a> on September 16-19th,
register with the code <code>JWFOSS</code> for a 30% discount off your pass.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<!-- starting partial author.html.haml -->
<div id="about-the-author">
<b class="author about-header">
About the Author
</b>
<table class="author box">
<tr>
<td>
<!-- starting partial avatar.html.haml -->
<img alt="Mandy Hubbard" class="author logo" src="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/images/avatars/devmandy.jpeg">

<!-- ending partial avatar.html.haml -->
</td>
<td>
<b class="author name">
<a href="/blog/authors/devmandy">
Mandy Hubbard
</a>
</b>
<p>
<div class="paragraph">
<p>Mandy Hubbard has almost 20 years of professional QA experience,
most of which has been spent in fast-paced startup environments driving product quality.
She is passionate about ensuring quality through process improvements, test automation, following CI/CD best practices and all things DevOps.
She is currently a software engineer/QA architect at CS Disco, an innovative startup delivering a cloud-based eDiscovery platform.</p>
</div>
</p>
<!-- starting partial social-media-buttons.html.haml -->
<ul class="author social-media-buttons">
<li class="author">
<a href="https://github.com/DevMandy" target="_blank">
GitHub
</a>
</li>
<li class="author">
<a href="https://twitter.com/DevMandy" target="_blank">
Twitter
</a>
</li>
</ul>

<!-- ending partial social-media-buttons.html.haml -->
</td>
</tr>
</table>
</div>

<!-- ending partial author.html.haml -->
</div>
</div>
</div>


<script src="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/assets/bower/anchor-js/anchor.min.js"></script>
<script src="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/assets/bower/tether/js/tether.min.js"></script>
<script src="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/assets/bower/bootstrap/js/bootstrap.min.js"></script>
<footer id="footer">
<div class="container">
<div class="row">
<div class="col-md-4">
<p class="box">
<a href="https://github.com/jenkins-infra/jenkins.io/edit/master/content//blog/2018/09/2018-09-14-kubernetes-and-secret-agents.adoc" title="Edit /blog/2018/09/2018-09-14-kubernetes-and-secret-agents.adoc on GitHub">Improve this page</a>
|
<a href="https://github.com/jenkins-infra/jenkins.io/commits/master/content//blog/2018/09/2018-09-14-kubernetes-and-secret-agents.adoc" title="View /blog/2018/09/2018-09-14-kubernetes-and-secret-agents.adoc history on GitHub">Page history</a>
</p>
<div class="license-box">
<div id="creativecommons">
<a href="https://creativecommons.org/licenses/by-sa/4.0/">
<p>
<img alt="Creative Commons Attribution-ShareAlike license" src="https://licensebuttons.net/l/by-sa/4.0/88x31.png">
</p>
</a>
<p>
The content driving this site is licensed under the Creative
Commons Attribution-ShareAlike 4.0 license.
</p>
</div>
</div>
</div>
<div class="links col-md-8">
<div class="container">
<div class="row">
<div class="area col-md-3">
<div class="div-mar">
<h5>Resources</h5>
<ul class="resources">
<li>
<a href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/events">
Events
</a>
</li>
<li>
<a href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/doc">
Documentation
</a>
</li>
<li>
<a href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/node">
Blog
</a>
</li>
</ul>
</div>
</div>
<div class="area col-md-3">
<div class="div-mar">
<h5>Solutions</h5>
<ul>
<li>
<a href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/solutions/android">
Android
</a>
</li>
<li>
<a href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/solutions/c">
C/C++
</a>
</li>
<li>
<a href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/solutions/docker">
Docker
</a>
</li>
<li>
<a href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/solutions/embedded">
Embedded
</a>
</li>
<li>
<a href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/solutions/github">
GitHub
</a>
</li>
<li>
<a href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/solutions/java">
Java
</a>
</li>
<li>
<a href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/solutions/php">
PHP
</a>
</li>
<li>
<a href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/solutions/pipeline">
Continuous Delivery
</a>
</li>
<li>
<a href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/solutions/python">
Python
</a>
</li>
<li>
<a href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/solutions/ruby">
Ruby
</a>
</li>
</ul>
</div>
</div>
<div class="area col-md-3">
<div class="div-mar">
<h5>Project</h5>
<ul class="project">
<li>
<a href="https://issues.jenkins-ci.org">
Issue tracker
</a>
</li>
<li>
<a href="https://wiki.jenkins.io">
Wiki
</a>
</li>
<li>
<a href="https://github.com/jenkinsci">
GitHub
</a>
</li>
<li>
<a href="https://ci.jenkins.io">
Jenkins on Jenkins
</a>
</li>
</ul>
</div>
</div>
<div class="area col-md-3">
<div class="div-mar">
<h5>Community</h5>
<ul class="community">
<li>
<a href="https://groups.google.com/forum/#!forum/jenkinsci-users">
Users mailing list
</a>
</li>
<li>
<a href="https://groups.google.com/forum/#!forum/jenkinsci-dev">
Developers mailing list
</a>
</li>
<li>
<a href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/sigs">
Special Interest Groups
</a>
</li>
<li>
<a href="https://twitter.com/jenkinsci">
Twitter
</a>
</li>
<li>
<a href="https://reddit.com/r/jenkinsci">
Reddit
</a>
</li>
<li>
<a href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/merchandise">
Merchandise
</a>
</li>
<li>
<a href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/awards">
Awards
</a>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</footer>
<script>
 (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
 
ga('create', 'UA-000000-0', 'auto');
ga('send', 'pageview');
ga('set', 'anonymizeIp', true);

</script>

<script>
  !function(d,s,id) {
    var js, fjs=d.getElementsByTagName(s)[0];
    if (!d.getElementById(id)) {
      js = d.createElement(s);
      js.id=id;
      js.src="//platform.twitter.com/widgets.js";
      fjs.parentNode.insertBefore(js,fjs);
    }
  }(document,"script","twitter-wjs");
  
  $(function(){
    var $body = $(document.body);
    $(".nav-link.dropdown-toggle").on("mousedown", function(){
      $body.addClass("no-outline");
    })
    $body.on("keydown", function(){
      $body.removeClass("no-outline");
    })
  })
</script>
</body>
</html>
