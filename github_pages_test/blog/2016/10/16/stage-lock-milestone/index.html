<!DOCTYPE html>
<html lang="en">
<head>
<title>
Controlling the Flow with Stage, Lock, and Milestone
</title>
<meta content="text/html; charset=UTF-8" http-equiv="Content-Type">
<meta content="Jenkins – an open source automation server which enables developers around the world to reliably build, test, and deploy their software" name="description">
<link href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/sites/default/files/jenkins_favicon.ico" rel="shortcut icon" type="image/x-icon">
<meta charset="utf-8">
<meta content="width=device-width, initial-scale=1" name="viewport">
<meta content="ie=edge" http-equiv="x-ua-compatible">
<link href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/img/favicon.ico" rel="icon" sizes="32x32" type="img/png">
<link href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/img/favicon-32x32.png" rel="icon" sizes="32x32" type="image/png">
<link href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/img/favicon-16x16.png" rel="icon" sizes="16x16" type="image/png">
<link href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/img/apple-touch-icon-76x76.png" rel="apple-touch-icon" sizes="76x76">
<link href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/img/apple-touch-icon-120x120.png" rel="apple-touch-icon" sizes="120x120">
<link href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/img/apple-touch-icon-152x152.png" rel="apple-touch-icon" sizes="152x152">
<meta content="Controlling the Flow with Stage, Lock, and Milestone" name="apple-mobile-web-app-title">
<!-- Twitter Card data -->
<meta content="summary_large_image" name="twitter:card">
<meta content="@JenkinsCI" name="twitter:site">
<meta content="Controlling the Flow with Stage, Lock, and Milestone" name="twitter:title">
<meta content="Jenkins – an open source automation server which enables developers around the world to reliably build, test, and deploy their software" name="twitter:description">
<meta content="@JenkinsCI" name="twitter:creator">
<!-- Twitter Summary card images must be at least 120x120px -->
<meta content="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/images/logo-title-opengraph.png" name="twitter:image">
<!-- Open Graph data -->
<meta content="Controlling the Flow with Stage, Lock, and Milestone" property="og:title">
<meta content="article" property="og:type">
<meta content="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/blog/2016/10/16/stage-lock-milestone/index.html" property="og:url">
<meta content="Jenkins – an open source automation server which enables developers around the world to reliably build, test, and deploy their software" name="og:description">
<meta content="Controlling the Flow with Stage, Lock, and Milestone" property="og:site_name">
<meta content="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/images/logo-title-opengraph.png" name="og:image">
<link href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/assets/bower/bootstrap/css/bootstrap.min.css" media="screen" rel="stylesheet">
<link href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/assets/bower/tether/css/tether.min.css" media="screen" rel="stylesheet">
<link href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/css/font-icons.css" media="screen" rel="stylesheet">
<link href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/css/jenkins.css" media="screen" rel="stylesheet">
<!-- Non-obtrusive CSS styles -->
<link href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/assets/bower/ionicons/css/ionicons.min.css" media="screen" rel="stylesheet">
<link href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/css/footer.css" media="screen" rel="stylesheet">
<link href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/css/font-awesome.min.css" media="screen" rel="stylesheet">
</head>
<body>
<script src="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/assets/bower/jquery/jquery.min.js"></script>
<!-- starting partial toptoolbar.html.haml -->
<nav class="navbar navbar-expand-md navbar-dark top bg-dark fixed-top" id="ji-toolbar">
<a class="navbar-brand" href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test">
Jenkins
</a>
<button class="navbar-toggler" data-target="#CollapsingNavbar" data-toggle="collapse" type="button">
<span class="navbar-toggler-icon"></span>
</button>
<div class="collapse navbar-collapse" id="CollapsingNavbar">
<ul class="nav navbar-nav ml-auto">
<li class="nav-item">
<a class="nav-link" href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/node">
Blog
</a>
</li>
<li class="nav-item dropdown">
<!-- starting partial dropdown.html.haml -->
<button aria-expanded="false" aria-haspopup="true" class="nav-link dropdown-toggle" data-toggle="dropdown">
Documentation
</button>

<!-- ending partial dropdown.html.haml -->
<div class="dropdown-menu">
<a class="dropdown-item" href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/doc">
Use Jenkins
</a>
<a class="dropdown-item" href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/doc/developer">
Extend Jenkins
</a>
<span class="dropdown-item">
<strong>
Use-cases
</strong>
</span>
<a class="dropdown-item feature" href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/solutions/android">
&nbsp;-&nbsp;Android
</a>
<a class="dropdown-item feature" href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/solutions/c">
&nbsp;-&nbsp;C/C++
</a>
<a class="dropdown-item feature" href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/solutions/docker">
&nbsp;-&nbsp;Docker
</a>
<a class="dropdown-item feature" href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/solutions/embedded">
&nbsp;-&nbsp;Embedded
</a>
<a class="dropdown-item feature" href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/solutions/github">
&nbsp;-&nbsp;GitHub
</a>
<a class="dropdown-item feature" href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/solutions/java">
&nbsp;-&nbsp;Java
</a>
<a class="dropdown-item feature" href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/solutions/php">
&nbsp;-&nbsp;PHP
</a>
<a class="dropdown-item feature" href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/solutions/pipeline">
&nbsp;-&nbsp;Continuous Delivery
</a>
<a class="dropdown-item feature" href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/solutions/python">
&nbsp;-&nbsp;Python
</a>
<a class="dropdown-item feature" href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/solutions/ruby">
&nbsp;-&nbsp;Ruby
</a>
</div>
</li>
<li class="nav-item">
<a class="nav-link" href="https://plugins.jenkins.io/">
Plugins
</a>
</li>
<li class="nav-item dropdown">
<!-- starting partial dropdown.html.haml -->
<button aria-expanded="false" aria-haspopup="true" class="nav-link dropdown-toggle" data-toggle="dropdown">
Community
</button>

<!-- ending partial dropdown.html.haml -->
<div class="dropdown-menu">
<a class="dropdown-item feature" href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/participate">
Overview
</a>
<a class="dropdown-item feature" href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/chat" title="Chat with the rest of the Jenkins community on IRC">
Chat
</a>
<a class="dropdown-item feature" href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/projects/jam">
Meet
</a>
<a class="dropdown-item feature" href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/events">
Events
</a>
<a class="dropdown-item feature" href="https://issues.jenkins-ci.org/">
Issue Tracker
</a>
<a class="dropdown-item feature" href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/mailing-lists" title="Browse Jenkins mailing list archives and/or subscribe to lists">
Mailing Lists
</a>
<a class="dropdown-item feature" href="https://wiki.jenkins.io/">
Wiki
</a>
<a class="dropdown-item feature" href="https://accounts.jenkins.io/" title="Create/manage your account for accessing wiki, issue tracker, etc">
Account Management
</a>
<a class="dropdown-item feature" href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/sigs/">
<strong>
Special Interest Groups
</strong>
</a>
<a class="dropdown-item feature" href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/sigs/advocacy-and-outreach/">
&nbsp;-&nbsp;Advocacy and Outreach
</a>
<a class="dropdown-item feature" href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/sigs/chinese-localization/">
&nbsp;-&nbsp;Chinese Localization
</a>
<a class="dropdown-item feature" href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/sigs/cloud-native/">
&nbsp;-&nbsp;Cloud Native
</a>
<a class="dropdown-item feature" href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/sigs/docs/">
&nbsp;-&nbsp;Documentation
</a>
<a class="dropdown-item feature" href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/sigs/gsoc/">
&nbsp;-&nbsp;Google Summer of Code
</a>
<a class="dropdown-item feature" href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/sigs/hw-and-eda/">
&nbsp;-&nbsp;Hardware and EDA
</a>
<a class="dropdown-item feature" href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/sigs/pipeline-authoring/">
&nbsp;-&nbsp;Pipeline Authoring
</a>
<a class="dropdown-item feature" href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/sigs/platform/">
&nbsp;-&nbsp;Platform
</a>
</div>
</li>
<li class="dropdown nav-item">
<!-- starting partial dropdown.html.haml -->
<button aria-expanded="false" aria-haspopup="true" class="nav-link dropdown-toggle" data-toggle="dropdown">
Subprojects
</button>

<!-- ending partial dropdown.html.haml -->
<div class="dropdown-menu">
<a class="dropdown-item feature" href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/projects/">
Overview
</a>
<a class="dropdown-item feature" href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/projects/blueocean/">
Blue Ocean
</a>
<a class="dropdown-item feature" href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/projects/evergreen/">
Evergreen
</a>
<a class="dropdown-item feature" href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/projects/gsoc/">
Google Summer of Code in Jenkins
</a>
<a class="dropdown-item feature" href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/projects/infrastructure/">
Infrastructure
</a>
<a class="dropdown-item feature" href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/projects/jam/">
Jenkins Area Meetups
</a>
<a class="dropdown-item feature" href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/projects/jcasc/">
Jenkins Configuration as Code
</a>
<a class="dropdown-item feature" href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/projects/remoting/">
Jenkins Remoting
</a>
</div>
</li>
<li class="nav-item dropdown">
<!-- starting partial dropdown.html.haml -->
<button aria-expanded="false" aria-haspopup="true" class="nav-link dropdown-toggle" data-toggle="dropdown">
About
</button>

<!-- ending partial dropdown.html.haml -->
<div class="dropdown-menu">
<a class="dropdown-item" href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/security">
Security
</a>
<a class="dropdown-item" href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/press">
Press
</a>
<a class="dropdown-item" href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/awards">
Awards
</a>
<a class="dropdown-item" href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/project/conduct">
Conduct
</a>
<a class="dropdown-item" href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/artwork">
Artwork
</a>
</div>
</li>
<li class="nav-item dropdown">
<!-- starting partial dropdown.html.haml -->
<button aria-expanded="false" aria-haspopup="true" class="nav-link dropdown-toggle" data-toggle="dropdown">
English
</button>

<!-- ending partial dropdown.html.haml -->
<div class="dropdown-menu">
<a class="dropdown-item" href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/zh">
中文 Chinese
</a>
</div>
</li>
<li class="nav-item">
<a class="nav-link btn btn-outline-secondary" href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/download">
Download
</a>
</li>
</ul>
</div>
</nav>
<!-- Spacing to make the fixed-top sticky navbar not occlude any content below it -->
<div class="pt-4">
&nbsp;
</div>

<!-- ending partial toptoolbar.html.haml -->
<script>
  $(function () {
    for (var i = 1 ; i <= 6 ; i ++) {
      anchors.add('#content h' + i);
    }
  })
</script>
<div class="container blog-post">
<div class="row body">
<div class="col-md-11 col-md-offset-1 main-content" id="content">
<div id="content-top">
<h1>
<a href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/blog/2016/10/16/stage-lock-milestone/" title="Controlling the Flow with Stage, Lock, and Milestone">
Controlling the Flow with Stage, Lock, and Milestone
</a>
</h1>
<div style="float: right; clear: all;">
<a class="twitter-share-button" data-lang="en" href="https://twitter.com/share">
Tweet
</a>
</div>
<div class="post-attrs">
<span class="submitted">
Published on
2016-10-16
by
<a href="/blog/authors/hrmpw">Patrick Wolf</a>
</span>
<ul class="list-inline tags">
<li>
<a class="tag-link" href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/node/tags/pipeline">
pipeline
</a>
</li>
<li>
<a class="tag-link" href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/node/tags/newfeatures">
newfeatures
</a>
</li>
</ul>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This is a guest post by <a href="https://github.com/hrmpw">Patrick Wolf</a>,
Director of Product Management at <a href="https://cloudbees.com">CloudBees</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Recently the Pipeline team began making several changes to improve the <code>stage</code> step and increase control of concurrent builds in Pipeline. Until now the <code>stage</code> step has been the catch-all for functionality related to the flow of builds through the Pipeline: grouping build steps into visualized stages, limiting concurrent builds, and discarding stale builds.</p>
</div>
<div class="paragraph">
<p>In order to improve upon each of these areas independently we decided to break this functionality into discrete steps rather than push more and more features into an already packed <code>stage</code> step.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://wiki.jenkins.io/display/JENKINS/Pipeline+Stage+Step+Plugin">stage</a> - the <code>stage</code> step remains but is now focused on grouping steps and providing boundaries for Pipeline segments.</p>
</li>
<li>
<p><a href="https://wiki.jenkins.io/display/JENKINS/Lockable+Resources+Plugin">lock</a> - the <code>lock</code> step throttles the number of concurrent builds in a defined section of the Pipeline.</p>
</li>
<li>
<p><a href="https://wiki.jenkins.io/display/JENKINS/Pipeline+Milestone+Step+Plugin">milestone</a> - the <code>milestone</code> step automatically discards builds that will finish out of order and become stale.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Separating these concerns into explicit, independent steps allows for much greater control of Pipelines and broadens the set of possible use cases.</p>
</div>
<div class="sect2">
<h3 id="stage"><a class="anchor" href="#stage"></a>Stage</h3>
<div class="paragraph">
<p>The <code>stage</code> step is a primary building block in Pipeline, dividing the steps of a Pipeline into explicit units and helping to visualize the progress using the "Stage View" plugin or <a href="/projects/blueocean/">"Blue Ocean"</a>. Beginning with version 2.2 of "Pipeline Stage Step" plugin, the <code>stage</code> step now requires a block argument, wrapping all steps within the defined stage. This makes the boundaries of where each <code>stage</code> begins and ends obvious and predictable. In addition, the concurrency argument of <code>stage</code> has now been removed to make this step more concise; responsibility for concurrency control has been delegated to the <code>lock</code> step.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="groovy">stage(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Build</span><span style="color:#710">'</span></span>) {
  doSomething()
  sh <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">echo </span><span style="background-color:hsla(0,0%,0%,0.07);color:black"><span style="font-weight:bold;color:#666">$</span>PATH</span><span style="color:#710">&quot;</span></span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Omitting the block from <code>stage</code> and using the concurrency argument are now deprecated in Pipeline. Pipelines using this syntax will continue to function but will produce a warning in the console log:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">Using the 'stage' step without a block argument is deprecated</pre>
</div>
</div>
<div class="paragraph">
<p>This message is only a reminder to update your Pipeline scripts; none of your Pipelines will stop working. If we reach a point where the old syntax is to be removed we will make an announcement prior to the change. We do, however, recommend that you update your existing Pipelines to utilize the new syntax.</p>
</div>
<div class="paragraph">
<p><strong>note:</strong> Stage View and Blue Ocean will both work with either the old <code>stage</code> syntax or the new.</p>
</div>
</div>
<div class="sect2">
<h3 id="lock"><a class="anchor" href="#lock"></a>Lock</h3>
<div class="paragraph">
<p>Rather than attempt to limit the number of concurrent builds of a job using the <code>stage</code>, we now rely on the "Lockable Resources" plugin and the <code>lock</code> step to control this. The <code>lock</code> step limits concurrency to a single build and it provides much greater flexibility in designating where the concurrency is limited.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>lock</code> can be used to constrain an entire <code>stage</code> or just a segment:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="groovy">stage(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Build</span><span style="color:#710">'</span></span>) {
  doSomething()
  lock(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">myResource</span><span style="color:#710">'</span></span>) {
    echo <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">locked build</span><span style="color:#710">&quot;</span></span>
  }
}</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>lock</code> can be also used to wrap multiple stages into a single concurrency unit:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="groovy">lock(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">myResource</span><span style="color:#710">'</span></span>) {
  stage(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Build</span><span style="color:#710">'</span></span>) {
    echo <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Building</span><span style="color:#710">&quot;</span></span>
  }
  stage(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Test</span><span style="color:#710">'</span></span>) {
    echo <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Testing</span><span style="color:#710">&quot;</span></span>
  }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="milestone"><a class="anchor" href="#milestone"></a>Milestone</h3>
<div class="paragraph">
<p>The <code>milestone</code> step is the last piece of the puzzle to replace functionality originally intended for <code>stage</code> and adds even more control for handling concurrent builds of a job. The <code>lock</code> step limits the number of builds running concurrently in a section of your Pipeline while the <code>milestone</code> step ensures that older builds of a job will not overwrite a newer build.</p>
</div>
<div class="paragraph">
<p>Concurrent builds of the same job do not always run at the same rate. Depending on the network, the node used, compilation times, test times, etc. it is always possible for a newer build to complete faster than an older build. For example:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Build 1 is triggered</p>
</li>
<li>
<p>Build 2 is triggered</p>
</li>
<li>
<p>Build 2 builds faster than Build 1 and enters the Test stage sooner.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Rather than allowing Build 1 to continue and possibly overwrite the newer artifact produced in Build 2, you can use the <code>milestone</code> step to abort Build 1:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="groovy">stage(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Build</span><span style="color:#710">'</span></span>) {
  milestone()
  echo <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Building</span><span style="color:#710">&quot;</span></span>
}
stage(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Test</span><span style="color:#710">'</span></span>) {
  milestone()
  echo <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Testing</span><span style="color:#710">&quot;</span></span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>When using the <code>input</code> step or the <code>lock</code> step a backlog of concurrent builds can easily stack up, either waiting for user input or waiting for a resource to become free. The <code>milestone</code> step will automatically prune all older jobs that are waiting at these junctions.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="groovy">milestone()
input <span style="color:#606">message</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Proceed?</span><span style="color:#710">&quot;</span></span>
milestone()</code></pre>
</div>
</div>
<div class="paragraph">
<p>Bookending an <code>input</code> step like this allows you to select a specific build to proceed and automatically abort all antecedent builds.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="groovy">milestone()
lock(<span style="color:#606">resource</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">myResource</span><span style="color:#710">'</span></span>, <span style="color:#606">inversePrecedence</span>: <span style="color:#069">true</span>) {
  echo <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">locked step</span><span style="color:#710">&quot;</span></span>
  milestone()
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Similarly a pair of <code>milestone</code> steps used with a <code>lock</code> will discard all old builds waiting for a shared resource. In this example, <code>inversePrecedence: true</code> instructs the <code>lock</code> to begin most recent waiting build first, ensuring that the most recent code takes precedence.</p>
</div>
</div>
<div class="sect2">
<h3 id="putting-it-all-together"><a class="anchor" href="#putting-it-all-together"></a>Putting it all together</h3>
<div class="paragraph">
<p>Each of these steps can be used independently of the others to control one aspect of a Pipeline or they can be combined to provide powerful, fine-grained control of every aspect of multiple concurrent builds flowing through a Pipeline. Here is a very simple example utilizing all three:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="groovy">stage(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Build</span><span style="color:#710">'</span></span>) {
  <span style="color:#777">// The first milestone step starts tracking concurrent build order</span>
  milestone()
  node {
    echo <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Building</span><span style="color:#710">&quot;</span></span>
  }
}

<span style="color:#777">// This locked resource contains both Test stages as a single concurrency Unit.</span>
<span style="color:#777">// Only 1 concurrent build is allowed to utilize the test resources at a time.</span>
<span style="color:#777">// Newer builds are pulled off the queue first. When a build reaches the</span>
<span style="color:#777">// milestone at the end of the lock, all jobs started prior to the current</span>
<span style="color:#777">// build that are still waiting for the lock will be aborted</span>
lock(<span style="color:#606">resource</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">myResource</span><span style="color:#710">'</span></span>, <span style="color:#606">inversePrecedence</span>: <span style="color:#069">true</span>){
  node(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">test</span><span style="color:#710">'</span></span>) {
    stage(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Unit Tests</span><span style="color:#710">'</span></span>) {
      echo <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Unit Tests</span><span style="color:#710">&quot;</span></span>
    }
    stage(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">System Tests</span><span style="color:#710">'</span></span>) {
      echo <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">System Tests</span><span style="color:#710">&quot;</span></span>
    }
  }
  milestone()
}

<span style="color:#777">// The Deploy stage does not limit concurrency but requires manual input</span>
<span style="color:#777">// from a user. Several builds might reach this step waiting for input.</span>
<span style="color:#777">// When a user promotes a specific build all preceding builds are aborted,</span>
<span style="color:#777">// ensuring that the latest code is always deployed.</span>
stage(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Deploy</span><span style="color:#710">'</span></span>) {
  input <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Deploy?</span><span style="color:#710">&quot;</span></span>
  milestone()
  node {
    echo <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Deploying</span><span style="color:#710">&quot;</span></span>
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>For a more complete and complex example utilizing all these steps in a Pipeline check out the  <a href="https://github.com/jenkinsci/workflow-aggregator-plugin/blob/8a69bb4506d270c4a1fc58580519a0bcac1b8bce/demo/repo/Jenkinsfile">Jenkinsfile</a> provided with the <a href="https://github.com/jenkinsci/workflow-aggregator-plugin/tree/8a69bb4506d270c4a1fc58580519a0bcac1b8bce/demo">Docker image for demonstrating Pipeline</a>. This is a working demo that can be quickly set up and run.</p>
</div>
</div>
<!-- starting partial author.html.haml -->
<div id="about-the-author">
<b class="author about-header">
About the Author
</b>
<table class="author box">
<tr>
<td>
<!-- starting partial avatar.html.haml -->
<img alt="Patrick Wolf" class="author logo" src="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/images/logos/transparent/transparent.svg">

<!-- ending partial avatar.html.haml -->
</td>
<td>
<b class="author name">
<a href="/blog/authors/hrmpw">
Patrick Wolf
</a>
</b>
<p>
This author has no biography defined.
See social media links referenced below.
</p>
<!-- starting partial social-media-buttons.html.haml -->
<ul class="author social-media-buttons">
<li class="author">
<a href="https://github.com/HRMPW" target="_blank">
GitHub
</a>
</li>
<li class="author">
<a href="https://twitter.com/hrmpw" target="_blank">
Twitter
</a>
</li>
</ul>

<!-- ending partial social-media-buttons.html.haml -->
</td>
</tr>
</table>
</div>

<!-- ending partial author.html.haml -->
</div>
</div>
</div>


<script src="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/assets/bower/anchor-js/anchor.min.js"></script>
<script src="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/assets/bower/tether/js/tether.min.js"></script>
<script src="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/assets/bower/bootstrap/js/bootstrap.min.js"></script>
<footer id="footer">
<div class="container">
<div class="row">
<div class="col-md-4">
<p class="box">
<a href="https://github.com/jenkins-infra/jenkins.io/edit/master/content//blog/2016/2016-10-16-stage-lock-milestone.adoc" title="Edit /blog/2016/2016-10-16-stage-lock-milestone.adoc on GitHub">Improve this page</a>
|
<a href="https://github.com/jenkins-infra/jenkins.io/commits/master/content//blog/2016/2016-10-16-stage-lock-milestone.adoc" title="View /blog/2016/2016-10-16-stage-lock-milestone.adoc history on GitHub">Page history</a>
</p>
<div class="license-box">
<div id="creativecommons">
<a href="https://creativecommons.org/licenses/by-sa/4.0/">
<p>
<img alt="Creative Commons Attribution-ShareAlike license" src="https://licensebuttons.net/l/by-sa/4.0/88x31.png">
</p>
</a>
<p>
The content driving this site is licensed under the Creative
Commons Attribution-ShareAlike 4.0 license.
</p>
</div>
</div>
</div>
<div class="links col-md-8">
<div class="container">
<div class="row">
<div class="area col-md-3">
<div class="div-mar">
<h5>Resources</h5>
<ul class="resources">
<li>
<a href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/events">
Events
</a>
</li>
<li>
<a href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/doc">
Documentation
</a>
</li>
<li>
<a href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/node">
Blog
</a>
</li>
</ul>
</div>
</div>
<div class="area col-md-3">
<div class="div-mar">
<h5>Solutions</h5>
<ul>
<li>
<a href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/solutions/android">
Android
</a>
</li>
<li>
<a href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/solutions/c">
C/C++
</a>
</li>
<li>
<a href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/solutions/docker">
Docker
</a>
</li>
<li>
<a href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/solutions/embedded">
Embedded
</a>
</li>
<li>
<a href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/solutions/github">
GitHub
</a>
</li>
<li>
<a href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/solutions/java">
Java
</a>
</li>
<li>
<a href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/solutions/php">
PHP
</a>
</li>
<li>
<a href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/solutions/pipeline">
Continuous Delivery
</a>
</li>
<li>
<a href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/solutions/python">
Python
</a>
</li>
<li>
<a href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/solutions/ruby">
Ruby
</a>
</li>
</ul>
</div>
</div>
<div class="area col-md-3">
<div class="div-mar">
<h5>Project</h5>
<ul class="project">
<li>
<a href="https://issues.jenkins-ci.org">
Issue tracker
</a>
</li>
<li>
<a href="https://wiki.jenkins.io">
Wiki
</a>
</li>
<li>
<a href="https://github.com/jenkinsci">
GitHub
</a>
</li>
<li>
<a href="https://ci.jenkins.io">
Jenkins on Jenkins
</a>
</li>
</ul>
</div>
</div>
<div class="area col-md-3">
<div class="div-mar">
<h5>Community</h5>
<ul class="community">
<li>
<a href="https://groups.google.com/forum/#!forum/jenkinsci-users">
Users mailing list
</a>
</li>
<li>
<a href="https://groups.google.com/forum/#!forum/jenkinsci-dev">
Developers mailing list
</a>
</li>
<li>
<a href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/sigs">
Special Interest Groups
</a>
</li>
<li>
<a href="https://twitter.com/jenkinsci">
Twitter
</a>
</li>
<li>
<a href="https://reddit.com/r/jenkinsci">
Reddit
</a>
</li>
<li>
<a href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/merchandise">
Merchandise
</a>
</li>
<li>
<a href="https://tempora-mutantur.github.io/jenkins.io/github_pages_test/awards">
Awards
</a>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</footer>
<script>
 (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
 
ga('create', 'UA-000000-0', 'auto');
ga('send', 'pageview');
ga('set', 'anonymizeIp', true);

</script>

<script>
  !function(d,s,id) {
    var js, fjs=d.getElementsByTagName(s)[0];
    if (!d.getElementById(id)) {
      js = d.createElement(s);
      js.id=id;
      js.src="//platform.twitter.com/widgets.js";
      fjs.parentNode.insertBefore(js,fjs);
    }
  }(document,"script","twitter-wjs");
  
  $(function(){
    var $body = $(document.body);
    $(".nav-link.dropdown-toggle").on("mousedown", function(){
      $body.addClass("no-outline");
    })
    $body.on("keydown", function(){
      $body.removeClass("no-outline");
    })
  })
</script>
</body>
</html>
